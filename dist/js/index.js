"use strict";var objectsData,playersData,player1,player2,weapon1,weapon2,weapon3,weapon4,weapon0,canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),boardWidth=canvas.width,boardSize=11,tileWidth=boardWidth/boardSize,initMatrix=function(){objectsData=[],playersData=[];for(var e=0;e<boardSize;e++){for(var a=[],t=0;t<boardSize;t++)a.push(0);objectsData.push(a)}for(var n=0;n<boardSize;n++){for(var o=[],i=0;i<boardSize;i++)o.push(0);playersData.push(o)}},imgs={obstacle:document.getElementById("obstacle"),player1:document.getElementById("player1"),player2:document.getElementById("player2"),weapon1:document.getElementById("weapon1"),weapon2:document.getElementById("weapon2"),weapon3:document.getElementById("weapon3"),weapon4:document.getElementById("weapon4"),weapon0:document.getElementById("weapon0")},DOMStrings={canvas:"#canvas",player1DetailBox:".detailBox--player1",player2DetailBox:".detailBox--player2",player1LifePoint:"#player1_lifePoint",player2LifePoint:"#player2_lifePoint",player1Weapon:"#player1_weapon",player2Weapon:"#player2_weapon",player1Damage:"#player1_damage",player2Damage:"#player2_damage",player1ShieldState:"#player1_shield_state",player2ShieldState:"#player2_shield_state",rulesBox:".rulesBox",msgBox:"#message-box",currentPlayer:"#playerInturn",optionBtn:".choice",attackBtn:"#btn-attack",defenseBtn:"#btn-defense",newgameBtn:"button.btn--newgame",rulesBtn:"button.btn--rules"},turnIntoCoord=function(e){var a;return a=parseInt(e%boardSize),[Math.floor(e/boardSize),a]},distance=function(e,a){var t=Math.sqrt(Math.pow(e[0]-a[0],2)+Math.pow(e[1]-a[1],2));return t},calcPath=function(e,a){var t,n,o,i,r,l;if(t=distance(e,a),n=e[0],o=e[1],i=a[0],r=a[1],n==i||o==r){l=[];var s=o<r||n<i?1:-1;if(n==i)for(var p=o,c=0;c<t;c++)p+=s,l.push([n,p]);else if(o==r)for(var d=n,h=0;h<t;h++)d+=s,l.push([d,o])}return l},validatePath=function(e){if(!e)return!1;if(e.length<=3){var a=!0,t=!1,n=void 0;try{for(var o,i=e[Symbol.iterator]();!(a=(o=i.next()).done);a=!0){var r=o.value;if(1==objectsData[r[0]][r[1]]||-1!=[1,2].indexOf(playersData[r[0]][r[1]]))return!1}}catch(e){t=!0,n=e}finally{try{a||null==i.return||i.return()}finally{if(t)throw n}}return!0}},calcValidAreaToMove=function(e){for(var a=e[0],t=e[1],n=[],o=-3;o<=3;o++){if(0<=t+o&&t+o<boardSize&&0!=o){var i=[a,t+o],r=calcPath(e,i);validatePath(r)&&n.push(i)}if(0<=a+o&&a+o<boardSize&&0!=o){var l=[a+o,t],s=calcPath(e,l);validatePath(s)&&n.push(l)}}return n},onWeapon=function(e){var a=e.position[0],t=e.position[1];return-1!=[4,5,6,7,8].indexOf(objectsData[a][t])},Player=function(){};Player.prototype={constructor:Player,lifePoint:100,shieldState:!1,moveTo:function(e){var i=this,r=calcPath(this.position,e);if(validatePath(r))return new Promise(function(e,a){flag=3,$(DOMStrings.canvas).off("click");var t=r.length,n=250*(t+1);if(0!=t){tempPositionIndex=0;var o=setInterval(function(){var e,a;e=r[tempPositionIndex][0],a=r[tempPositionIndex][1],playersData[e][a]=i.ID,playersData[i.position[0]][i.position[1]]=0,i.position=[e,a],onWeapon(i)&&i.swapWeapon(),tempPositionIndex==r.length-1?clearInterval(o):tempPositionIndex++,console.log("is moving.")},250)}setTimeout(function(){e(),console.log("moving done.")},n)})},swapWeapon:function(){var e=this.position[0],a=this.position[1],t=objectsData[e][a];switch(objectsData[e][a]=this.weapon.ID,t){case 4:this.weapon=new Weapon1;break;case 5:this.weapon=new Weapon2;break;case 6:this.weapon=new Weapon3;break;case 7:this.weapon=new Weapon4;break;default:this.weapon=new Weapon0}},fight:function(e){var a;1==this.shieldState&&0==e.shieldState?a=Math.floor(e.weapon.damage/2):1==e.shieldState?a=0:0==this.shieldState&&0==e.shieldState&&(a=e.weapon.damage),this.lifePoint-=a,console.log("fight")},updateShieldState:function(){$(DOMStrings.msgBox).addClass("message-box--active"),$(DOMStrings.currentPlayer).text("Next turn, ".concat(this.name," chooses to ...")),console.log("shield.")}};var Player1=function(){this.name="TOM",this.ID=1};Player1.prototype=Object.create(Player.prototype),Player1.prototype.constructor=Player1;var Player2=function(){this.name="JERRY",this.ID=2};Player2.prototype=Object.create(Player.prototype),Player2.prototype.constructor=Player2;var Weapon=function(){};Weapon.prototype={constructor:Weapon};var flag,Weapon1=function(){Weapon.call(this),this.name="Weapon 1",this.ID=4,this.damage=Math.floor(6*Math.random()+8)},Weapon2=function(){Weapon.call(this),this.name="Weapon 2",this.ID=5,this.damage=Math.floor(6*Math.random()+8)},Weapon3=function(){Weapon.call(this),this.name="Weapon 3",this.ID=6,this.damage=Math.floor(6*Math.random()+8)},Weapon4=function(){Weapon.call(this),this.name="Weapon 4",this.ID=7,this.damage=Math.floor(6*Math.random()+8)},Weapon0=function(){Weapon.call(this),this.name="Default Weapon",this.ID=8,this.damage=10},createPlayers=function(){player1=new Player1,player2=new Player2},createWeapons=function(){weapon0=new Weapon0,weapon1=new Weapon1,weapon2=new Weapon2,weapon3=new Weapon3,weapon4=new Weapon4},tile_padding=6,icon_real_size=64,icon_drawn_size=tileWidth-2*tile_padding,drawGrid=function(){ctx.fillStyle="#805006",ctx.fillRect(0,0,canvas.width,canvas.height);for(var e=1;e<boardSize;e++)ctx.beginPath(),ctx.strokeStyle="#A46400",ctx.moveTo(tileWidth*e,0),ctx.lineTo(tileWidth*e,boardWidth),ctx.moveTo(0,tileWidth*e),ctx.lineTo(boardWidth,tileWidth*e),ctx.stroke();for(var a=1;a<boardSize;a++)for(var t=1;t<boardSize;t++)ctx.fillStyle="black",ctx.fillRect(tileWidth*t-1.2,tileWidth*a-1.2,2.5,2.5),ctx.fill()},drawObstacle=function(e,a){var t;t=imgs.obstacle,e=e*tileWidth+2*tile_padding,a=a*tileWidth+tile_padding,ctx.drawImage(t,0,0,icon_real_size,icon_real_size,a,e,icon_drawn_size,icon_drawn_size)},drawWeapon=function(e,a,t){var n;switch(a=a*tileWidth+tile_padding,t=t*tileWidth+tile_padding,e){case 4:n=imgs.weapon1;break;case 5:n=imgs.weapon2;break;case 6:n=imgs.weapon3;break;case 7:n=imgs.weapon4;break;case 8:n=imgs.weapon0}ctx.drawImage(n,0,0,icon_real_size,icon_real_size,t,a,icon_drawn_size,icon_drawn_size)},drawPlayer=function(e){var a;1==e.ID?a=imgs.player1:2==e.ID&&(a=imgs.player2),x=e.position[0]*tileWidth+2*tile_padding-2.5,y=e.position[1]*tileWidth+tile_padding,ctx.drawImage(a,0,0,icon_real_size,icon_real_size,y,x,icon_drawn_size,icon_drawn_size)},drawPossibleMoves=function(e){calcValidAreaToMove(e).forEach(function(e){var a=e[0]*tileWidth+4.5,t=e[1]*tileWidth+4.5;ctx.strokeStyle="#258391",ctx.lineWidth=2,ctx.strokeRect(t,a,tileWidth-9,tileWidth-9)})};$(document).ready(function(){var a=function(){flag=Math.floor(2*Math.random()+1),initMatrix(),createWeapons(),createPlayers(),function(){var e,a,t,n;e=[],n=[];for(;16!=e.length;){var o=Math.floor(Math.random()*Math.pow(boardSize,2));e.push(o)}a=e.slice(0,12),t=e.slice(12);for(;2!=n.length;){var i=Math.floor(Math.random()*Math.pow(boardSize,2));if(-1==n.indexOf(i)&&-1==e.indexOf(i)&&n.push(i),2==n.length){var r=turnIntoCoord(n[0]),l=turnIntoCoord(n[1]);1==distance(r,l)&&n.pop()}}a=a.map(function(e){return e=turnIntoCoord(e)}),t=t.map(function(e){return e=turnIntoCoord(e)}),n=n.map(function(e){return e=turnIntoCoord(e)}),t.forEach(function(e,a){objectsData[e[0]][e[1]]=a+4}),n.forEach(function(e,a){playersData[e[0]][e[1]]=a+1}),a.forEach(function(e){objectsData[e[0]][e[1]]=1}),player1.weapon=weapon0,player2.weapon=weapon0,player1.position=n[0],player2.position=n[1]}(),e(),i(flag);$(DOMStrings.msgBox).html('<h2 id="playerInturn"></h2> <button class="btn choice attack" id="btn-attack">ATTACK</button> <button class="btn choice defense" id="btn-defense">DEFENSE</button>'),$(DOMStrings.msgBox).removeClass("message-box--active")};var t=function(){!function(){drawGrid();for(var e=0,a=0;a<boardSize;a++)for(var t=0;t<boardSize;t++)1==(e=objectsData[a][t])?drawObstacle(a,t):player1.position[0]==a&&player1.position[1]==t?drawPlayer(player1):player2.position[0]==a&&player2.position[1]==t?drawPlayer(player2):-1!=[4,5,6,7,8].indexOf(e)&&drawWeapon(e,a,t)}(),function(){var e,a,t,n,o,i;switch(e=player1.lifePoint<0?0:player1.lifePoint,t=player1.weapon,o=0==player1.shieldState?"ATTACK":"DEFENSE",a=player2.lifePoint<0?0:player2.lifePoint,n=player2.weapon,i=0==player2.shieldState?"ATTACK":"DEFENSE",$(DOMStrings.player1LifePoint).text(e),$(DOMStrings.player1ShieldState).text(o),$(DOMStrings.player1Damage).text(t.damage),$(DOMStrings.player2LifePoint).text(a),$(DOMStrings.player2ShieldState).text(i),$(DOMStrings.player2Damage).text(n.damage),t.ID){case 4:$(DOMStrings.player1Weapon).attr("src","img/weapons/w1-big.png");break;case 5:$(DOMStrings.player1Weapon).attr("src","img/weapons/w2-big.png");break;case 6:$(DOMStrings.player1Weapon).attr("src","img/weapons/w3-big.png");break;case 7:$(DOMStrings.player1Weapon).attr("src","img/weapons/w4-big.png");break;default:$(DOMStrings.player1Weapon).attr("src","img/weapons/w0-big.png")}switch(n.ID){case 4:$(DOMStrings.player2Weapon).attr("src","img/weapons/w1-big.png");break;case 5:$(DOMStrings.player2Weapon).attr("src","img/weapons/w2-big.png");break;case 6:$(DOMStrings.player2Weapon).attr("src","img/weapons/w3-big.png");break;case 7:$(DOMStrings.player2Weapon).attr("src","img/weapons/w4-big.png");break;default:$(DOMStrings.player2Weapon).attr("src","img/weapons/w0-big.png")}}(),1==flag?drawPossibleMoves(player1.position):2==flag&&drawPossibleMoves(player2.position)},e=function o(){$(DOMStrings.canvas).on("click",function(e){var t,a=[player1,player2];x=Math.floor((e.pageX-$(this).offset().left)/tileWidth),y=Math.floor((e.pageY-$(this).offset().top)/tileWidth);var n=[y,x];1==flag?t=a[0]:2==flag&&(t=a[1]),t.moveTo(n).then(function(){return e=player1,a=player2,console.log("is checking fight."),1==distance(e.position,a.position)&&(e.fight(a),a.fight(e)),new Promise(function(e,a){e()});var e,a}).then(function(){return function(){var e,a=player1.lifePoint,t=player2.lifePoint;if(!(a<=0||t<=0))return new Promise(function(e,a){e()});e=a<=0&&t<=0?"<h3>Draw</h3><h2>GAME OVER</h2>":"<h3> ".concat(0<t?player2.name:player1.name," won.</h3><h2>GAME OVER</h2>"),$(DOMStrings.msgBox).html(e),$(DOMStrings.msgBox).addClass("message-box--active")}()}).then(function(){t.updateShieldState()}),$(DOMStrings.optionBtn).unbind("click").on("click",function(e){var a=e.target;"btn-attack"==a.id?t.shieldState=!1:"btn-defense"==a.id&&(t.shieldState=!0),$(DOMStrings.msgBox).removeClass("message-box--active"),flag=t.ID,i(flag=1==flag?2:1),o()})})},i=function(e){1==e?($(DOMStrings.player2DetailBox).removeClass("active"),$(DOMStrings.player1DetailBox).addClass("active")):2==e&&($(DOMStrings.player1DetailBox).removeClass("active"),$(DOMStrings.player2DetailBox).addClass("active"))};$(DOMStrings.rulesBtn).unbind("click").on("click",function(e){e.preventDefault(),$(DOMStrings.rulesBox).toggleClass("rules-active")}),$(DOMStrings.newgameBtn).unbind("click").on("click",function(e){a(),setInterval(t,1e3/60),setInterval(createWeapons,3e3),$(DOMStrings.rulesBox).removeClass("rules-active")}),drawGrid()});